@{
    ViewData["Title"] = "Contatos";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

<div id="app" class="container">
    <div class="d-flex align-items-center justify-content-between">
        <h1 class="mt-4"> Agenda de contatos</h1>
        <button class="btn btn-primary" v-on:click="openCreate()">Novo Contato</button>
    </div>
    <div class="mt-3">
        <input type="text" class="form-control" placeholder="Search by name or email" v-model="search" />
    </div>
    <div class="mt-3">
        <table class="table table-hover align-middle table-responsive">
            <thead class="table-dark">
                <tr>
                    <th scope="col">Nome</th>
                    <th scope="col">Email</th>
                    <th scope="col">Telefone</th>
                    <th scope="col">Endereço</th>
                    <th scope="col">Ações</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="contact in filtered" :key="contact.id">
                    <td><span v-text="contact.name"></span></td>
                    <td><span v-text="contact.email"></span></td>
                    <td><span v-text="contact.phone"></span></td>
                    <td><span v-text="contact.address"></span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary me-2" v-on:click="Consult(contact.id)">Consultar</button>
                        <button class="btn btn-sm btn-secondary me-2" v-on:click="openUpdate(contact)">Editar</button>
                        <button class="btn btn-sm btn-danger" v-on:click="openRemove(contact)">Remover</button>
                    </td>
                </tr>
                <tr v-if="loading">
                    <td colspan="5" class="text-center">Carregando...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactModalLabel">Detalhes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <template v-if="selected">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <dl>
                                    <dt>Nome</dt>
                                    <dd><span v-text="selected.name"></span></dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl>
                                    <dt>Email</dt>
                                    <dd><span v-text="selected.email"></span></dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl>
                                    <dt>Phone</dt>
                                    <dd><span v-text="selected.phone"></span></dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl>
                                    <dt>Address</dt>
                                    <dd><span v-text="selected.address"></span></dd>
                                </dl>
                            </div>
                        </div>
                    </template>
                    <template v-else>
                        <div class="text-muted">Selecione um contato.</div>
                    </template>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Modal -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateModalLabel">Novo Contatot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form v-on:submit.prevent="UpdateContact()">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nome</label>
                                <input class="form-control" v-model.trim="formUpdate.name" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" v-model.trim="formUpdate.email" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input class="form-control" v-model.trim="formUpdate.phone" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Address</label>
                                <input class="form-control" v-model.trim="formUpdate.address" />
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Modal -->
    <div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createModalLabel">Novo Contato</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form v-on:submit.prevent="CreateContact()">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nome</label>
                                <input class="form-control" v-model.trim="form.name" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" v-model.trim="form.email" required />

                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Telefone</label>
                                <input type="text" v-model.trim="form.phone" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Endereço</label>
                                <input class="form-control" v-model.trim="form.address" />
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove Modal -->
    <div class="modal fade" id="removeModal" tabindex="-1" aria-labelledby="removeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="removeModalLabel">Remover contato</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja remover o contato <strong v-text="contactToRemove?.name"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" v-on:click="confirmRemove()">Remover</button>
                </div>
            </div>
        </div>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/vue@3.4.15/dist/vue.global.prod.js"></script>
<script>
    const api = '/api/contact';
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                contacts: [],
                loading: false,
                search: '',
                selected: null,
                modalInstance: null,
                updateModalInstance: null,
                createModalInstance: null,
                removeModalInstance: null,
                contactToRemove: null,
                formUpdate: { id: 0, name: '', email: '', phone: '', address: '' },
                form: { name: '', email: '', phone: '', address: '' }
            };
        },
        computed:{
            filtered(){
                const q = this.search.toLowerCase();
                return this.contacts.filter(c => c.name.toLowerCase().includes(q) || c.email.toLowerCase().includes(q) || c.phone.toLowerCase().includes(q));
            }
        },
        methods: {
            async load() {
                this.loading = true;
                try {
                    const res = await fetch(api);
                    if (!res.ok) {
                        const bodyText = await res.text();
                        console.error('Error:', res.status, bodyText);
                        return;
                    }
                    this.contacts = await res.json();
                } catch (err) {
                    console.error('Fail:', err);
                } finally {
                    this.loading = false;
                }
            },
            async Consult(id){
                try {
                    const res = await fetch(`${api}/${id}`);
                    if (res.status === 404) {
                        alert('Contact not founded');
                        return;
                    }
                    if (!res.ok) {
                        const bodyText = await res.text();
                        console.error('Error:', res.status, bodyText);
                        return;
                    }
                    this.selected = await res.json();
                    if (!this.modalInstance) {
                        const el = document.getElementById('contactModal');
                        this.modalInstance = new bootstrap.Modal(el, { backdrop: 'static' });
                    }
                    this.modalInstance.show();
                } catch (err) {
                    console.error('Error:', err);
                }
            },
            openCreate(){
                this.form = { name: '', email: '', phone: '', address: '' };
                if (!this.createModalInstance) {
                    const el = document.getElementById('createModal');
                    this.createModalInstance = new bootstrap.Modal(el, { backdrop: 'static' });
                }
                this.createModalInstance.show();
            },
            openUpdate(contact){
                this.formUpdate = { id: contact.id, name: contact.name, email: contact.email, phone: contact.phone, address: contact.address };
                if (!this.updateModalInstance) {
                    const el = document.getElementById('updateModal');
                    this.updateModalInstance = new bootstrap.Modal(el, { backdrop: 'static' });
                }
                this.updateModalInstance.show();
            },
            openRemove(contact){
                this.contactToRemove = contact;
                if (!this.removeModalInstance) {
                    const el = document.getElementById('removeModal');
                    this.removeModalInstance = new bootstrap.Modal(el, { backdrop: 'static' });
                }
                this.removeModalInstance.show();
            },
            async confirmRemove(){
                if (!this.contactToRemove) return;
                try {
                    const res = await fetch(`${api}/${this.contactToRemove.id}`, {
                        method: 'DELETE'
                    });
                    if (!res.ok && res.status !== 404){
                        const bodyText = await res.text();
                        console.error('Error:', res.status, bodyText);
                        return;
                    }
                    this.contacts = this.contacts.filter(c => c.id !== this.contactToRemove.id);
                    this.removeModalInstance.hide();
                    this.contactToRemove = null;
                } catch (err){
                    console.error('Error:', err);
                    alert('Falha ao remover contato');
                }
            },
            async CreateContact(){
                try {
                    const res  = await fetch(api, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.form)
                    });
                    if (!res.ok){
                         const bodyText = await res.text();
                        console.error('Error:', res.status, bodyText);
                        alert(bodyText || 'Erro ao criar contato');
                        return;
                    }
                    const created = await res.json();
                    this.contacts.push(created);
                    this.createModalInstance.hide();
                } catch (err){
                    console.error('Error:', err);
                    alert('Falha ao criar contato');
                }
            },
            async UpdateContact(){
                try {
                    const res  = await fetch(`${api}/${this.formUpdate.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: this.formUpdate.name,
                            email: this.formUpdate.email,
                            phone: this.formUpdate.phone,
                            address: this.formUpdate.address
                        })
                    });
                    if (!res.ok){
                         const bodyText = await res.text();
                        console.error('Error:', res.status, bodyText);
                        alert(bodyText || 'Erro ao atualizar contato');
                        return;
                    }
                    const updated = await res.json();
                    const idx = this.contacts.findIndex(c => c.id === updated.id);
                    if (idx >= 0) this.contacts[idx] = updated;
                    this.updateModalInstance.hide();
                } catch (err){
                    console.error('Error:', err);
                    alert('Falha ao atualizar contato');
                }
            }
        },
        mounted() {
            this.load();
        }
    }).mount('#app');
</script>
